---
title: 通用编辑器中动态Forms的规则编辑器
description: 使用通用编辑器中的规则编辑器创建动态、智能的表单。 无需编码即可添加条件逻辑、计算和交互行为。
feature: Edge Delivery Services
role: Admin, Architect, Developer
level: Intermediate
exl-id: 846f56e1-3a98-4a69-b4f7-40ec99ceb348
source-git-commit: ccfb85da187e828b5f7e8b1a8bae3f483209368d
workflow-type: tm+mt
source-wordcount: '3597'
ht-degree: 23%

---


# 通用编辑器中动态Forms的规则编辑器

通用编辑器中的规则编辑器允许您创建实时响应用户输入的智能动态表单。 您可以将静态表单转换为具有条件字段可视性、自动计算和复杂业务逻辑的交互式体验，而所有这些操作都无需编写代码。


## 您将了解的内容

在本指南结束时，您将执行以下操作：

- 了解规则的工作方式以及何时使用不同的规则类型
- 在通用编辑器中启用和访问规则编辑器
- 创建条件逻辑以动态显示或隐藏表单字段
- 实施自动计算和数据验证
- 为复杂的业务规则构建自定义函数
- 应用最佳实践以获得最佳表单性能

## 为何使用规则编辑器？

**将静态Forms转换为智能体验：**

- **条件逻辑**：根据用户选择显示相关字段
- **动态计算**：自动计算用户类型的值
- **数据验证**：提供实时反馈并防止错误
- **已改进UX**：降低表单复杂性并引导用户完成逻辑流程
- **无需编码**：非开发人员可访问可视化界面

**常见用例：**

- 具有条件扣减额的计税表单
- 具有分支路径的多步向导
- 包含费率计算的保险表单
- 包含条件问题的调查表单
- 具有动态定价的电子商务表单

## 规则的工作方式

规则是自动化说明，可让您的表单智能且响应速度快。 它们指定在满足某些条件时应发生的情况。

### **规则组件**

**条件**：计算为true或false的逻辑测试。

- “用户的收入是否超过5万美元？”
- “用户是否为保险范围选择了‘是’？”
- “表单字段是否为空？”

**操作**：满足条件时产生的结果。

- 显示或隐藏表单字段
- 自动计算值
- 显示验证消息
- 启用或禁用组件

### **规则逻辑模式**

**1. Condition-Action (When-Then)**

```
WHEN gross salary > 50000
THEN show "Additional Deduction" field
```

*最适合：*&#x200B;条件字段可见性，动态内容

**2。Action-Condition (Set-If)**

```
SET taxable income = gross salary - deductions
IF deductions are applicable
```

*最适合：*&#x200B;计算、数据转换

**3。 Action-Condition-Alternate (If-Then-Else)**

```
IF income > 50000
THEN show "High Income" fields
ELSE show "Standard Income" fields
```

*最适合于：*&#x200B;分支逻辑，互斥选项

### **真实示例**

**方案**：税费计算表单

- **条件**：“总薪金超过$50,000”
- **主要操作**：显示“附加扣款”字段
- **备用操作**：隐藏“附加扣款”字段
- **结果**：用户只能根据收入级别查看相关字段

## 先决条件

在开始使用规则编辑器之前，请确保您具备以下条件：

### **访问要求**

- 正在创作&#x200B;**AEM as a Cloud Service**&#x200B;的访问权限
- 已启用规则编辑器扩展的&#x200B;**通用编辑器**
- AEM环境中的表单编辑权限

### **技术要求**

- **基本表单设计知识**：熟悉表单组件及其属性
- **业务逻辑熟悉度**：能够定义条件要求
- **JavaScript基础知识**（仅自定义函数需要）

### **启用规则编辑器扩展**

默认情况下，通用编辑器中未启用规则编辑器扩展。您可以从[Extension Manager](/help/implementing/developing/extending/extension-manager.md)启用它。

**启用扩展后：**
选择表单组件时，![edit-rules](/help/forms/assets/edit-rules-icon.svg)图标会显示在右上角。

![通用编辑器规则编辑器](/help/edge/docs/forms/assets/universal-editor-rule-editor.png)
*图：选择表单组件时显示规则编辑器图标*

**访问规则编辑器：**

1. 在通用编辑器中选择任意表单组件。
2. 单击显示的![edit-rules](/help/forms/assets/edit-rules-icon.svg)图标。
3. 规则编辑器界面将在新面板中打开。

![规则编辑器用户界面](/help/edge/docs/forms/assets/rule-editor-for-field.png)
*图：用于编辑组件规则的规则编辑器界面*

>[!NOTE]
>
> 在本文中，“表单组件”和“表单对象”是指相同的元素（例如输入字段、按钮、面板等）。

## 规则编辑器界面概述

规则编辑器提供了一个用户友好的可视化界面，用于创建和管理规则：

![规则编辑器用户界面](/help/edge/docs/forms/assets/rule-editor-interface.png)
*图：带编号组件的完整规则编辑器界面*

### **接口组件**

**1. 组件标题和规则类型**

- **目的**：显示选定组件的名称和当前规则类型。
- **示例**：“输入总薪金”（文本输入）并选择“时间”规则。
- **提示**：始终确认您编辑的组件是否正确。

**2。表单对象和函数面板**

- **表单对象选项卡**：提供所有表单组件的分层视图。
   - 用于：引用规则中的其他字段。
   - 导航：展开或折叠以定位特定组件。
- **函数选项卡**：包含内置数学函数和逻辑函数。
   - 用于：执行复杂的计算和数据操作。
   - 类别：Math、String、Date和Validation函数。

**3。 面板切换按钮**

- **用途**：显示或隐藏对象和函数面板。
- **提示**：关闭面板以增加规则编辑工作区。
- **键盘快捷键**：在处理复杂规则时很有用。

**4。 可视化规则生成器**

- **目的**：用于构造规则逻辑的主区域。
- **功能**：拖放界面和下拉选择器。
- **工作流**：选择规则类型→定义条件→设置操作。

**5。 控制按钮**

- **完成**：保存规则并关闭编辑器。
- **取消**：放弃更改并关闭编辑器而不保存。
- **提示**：始终在单击“完成”之前测试您的规则。

### **规则管理**

为已具有规则的组件打开规则编辑器时：

![显示表单对象的可用规则](/help/edge/docs/forms/assets/rule-editor15.png)
*图：管理表单组件的现有规则*

**可用操作：**

- **查看**：查看规则摘要和逻辑。
- **编辑**：修改现有规则条件或操作。
- **重新排序**：更改规则的执行顺序（规则从上到下运行）。
- **启用/禁用**：暂时打开或关闭规则以进行测试。
- **删除**：永久删除规则。

>[!TIP]
>
> **规则执行顺序很重要**：规则是从上到下执行的。 将更具体的条件放在常规条件之前。

## 可用规则类型

规则编辑器提供了一组按功能划分的全面规则类型。 根据特定用例选择适当的类型：

### **条件逻辑规则**

**时间**

- **目的**：用作实现复杂逻辑的主要条件规则。
- **用例**：例如，“当用户选择‘已婚’时，显示配偶信息字段。”
- **逻辑模式**：条件→操作（带可选的替代操作）

**隐藏/显示**

- **目的**：根据指定的条件控制字段可见性。
- **用例**：隐藏不相关的部分或启用渐进式公开。
- **最佳实践**：用于创建简洁而集中的用户体验。

**启用/禁用**

- **目的**：根据条件控制字段是否可以交互。
- **用例**：禁用提交按钮，直到完成所有必填字段。
- **最佳实践**：向用户提供清晰的可视反馈。

### **数据操作规则**

**设置值**

- **目的**：自动填充字段值。
- **用例**：设置今天的日期、计算总数或复制字段之间的值。
- **最佳实践**：用于减少用户工作量并确保准确性。

**清除**&#x200B;的值

- **用途**：条件更改时从字段中删除数据。
- **用例**：父选择更改时清除依赖字段。
- **最佳实践**：保持数据完整性并防止孤立值。

**格式**

- **用途**：转换值的显示方式。
- **用例**：设置货币、电话号码或日期的格式。
- **最佳实践**：在不更改基础数据的情况下提高可读性。

### **验证规则**

**验证**

- **目的**：实现自定义验证逻辑。
- **用例**：强制实施复杂的业务规则或跨字段验证。
- **最佳实践**：提供明确且可操作的错误消息。

### **计算规则**

**数学表达式**

- **目的**：执行自动计算。
- **用例**：计税、合计或百分比。
- **最佳实践**：以用户类型实时更新计算。

### **用户界面规则**

**设置焦点**

- **目的**：引导用户关注特定字段。
- **用例**：专注于错误字段或指导用户完成向导步骤。
- **最佳实践**：请谨慎使用，以免中断用户流。

**设置属性**

- **用途**：动态修改组件属性。
- **用例**：在下拉列表中更改占位符文本或修改选项。
- **最佳实践**：通过上下文更改增强用户体验。

### **表单控件规则**

**提交表单**

- **目的**：以编程方式触发表单提交。
- **用例**：满足特定条件后自动提交。
- **最佳实践**：始终在提交之前验证表单。

**重置表单**

- **目的**：清除所有表单数据并将表单重置为其初始状态。
- **用例**：“重新开始”功能。
- **最佳实践**：在重置之前确认用户的操作。

**保存表单**

- **目的**：将表单另存为草稿以供稍后完成。
- **用例**：对于长表单或多会话工作流很有用。
- **最佳实践**：提供关于保存状态的明确反馈。

### **高级规则**

**调用服务**

- **目的**：调用外部API或服务。
- **用例**：地址查找、实时验证或数据扩充。
- **最佳实践**：正确处理加载状态和错误方案。

**添加/删除实例**

- **用途**：动态管理可重复部分。
- **用例**：添加家庭成员或多个地址。
- **最佳实践**：提供用于添加或删除实例的清晰控件。

**导航到**

- **目的**：将用户重定向到其他表单或页面。
- **用例**：多表单工作流或条件路由。
- **最佳实践**：导航前保留表单数据。

**在面板之间导航**

- **用途**：控件在向导式表单中导航。
- **用例**：多步骤表单或条件步骤跳过。
- **最佳实践**：显示清晰的进度指示器。

**分派事件**

- **用途**：触发高级集成的自定义事件。
- **用例**： Analytics跟踪或第三方集成。
- **最佳实践**：仅用于非阻止操作。


## 分步教程：构建智能税务计算器

本节提供了一个用于演示规则编辑器功能的实际示例。 此示例将指导您完成使用条件逻辑和自动计算的税务计算表单的构建。

![显示创建条件规则的规则编辑器界面屏幕截图，该条件规则具有表单字段可见性的When-Then逻辑](/help/edge/docs/forms/assets/rule-editor-1.png)
*图：具有智能条件字段的计税表单*

### **教程概述**

在本教程中，您将创建一个表单，该表单：

1. **适应用户输入**：根据收入级别显示相关字段。
2. **自动计算**：实时计算应纳税额。
3. **验证数据**：确保准确的计算和数据输入。

### **表单结构**

| 字段名 | 类型 | 用途 | 行为 |
|------------|------|---------|----------|
| **工资总额** | 数字输入 | 用户输入年收入 | 触发条件逻辑 |
| **附加扣款** | 数字输入 | 附加扣减额（如果适用） | 在薪金> $50,000时显示 |
| **应纳税收入** | 数字输入 | 自动计算 | 更新输入更改 |
| **应付税款** | 数字输入 | 最终税额 | 按10%的速率计算 |

### 要实施的&#x200B;**业务逻辑**

**规则1：条件字段显示**

```
WHEN Gross Salary > 50,000
THEN Show "Additional Deduction" field
ELSE Hide "Additional Deduction" field
```

**规则2：应纳税收入计算**

```
SET Taxable Income = Gross Salary - Additional Deduction
(When Additional Deduction is applicable)
```

**规则3：税费计算**

```
SET Tax Payable = Taxable Income × 10%
(Simplified flat rate for demonstration)
```

### **实施步骤**

按照以下步骤构建您的智能纳税表单：



+++ 1：创建Foundation表单

**目标**：使用所有必需的组件构建基本窗体结构

要在通用编辑器中创建计税表单，请执行以下操作：

1. **打开通用编辑器**
   - 导航到AEM Sites控制台
   - 选择要添加表单的页面
   - 单击&#x200B;**编辑**&#x200B;以打开通用编辑器

2. **添加表单组件**

   按顺序添加这些组件：

   | 组件 | 类型 | 标签 | 设置 |
   |-----------|------|-------|----------|
   | 标题 | 标题 | “计税表单” | 标题级别H2 |
   | 数字输入 | 数字输入 | “工资总额” | 必需：是，占位符：“输入年薪” |
   | 数字输入 | 数字输入 | 附加扣除额 | 必需：否，占位符：“输入附加扣减额” |
   | 数字输入 | 数字输入 | 应课税收入 | 必需：否，只读：是 |
   | 数字输入 | 数字输入 | 应缴税项 | 必需：否，只读：是 |
   | 提交按钮 | 提交 | 计税 | 类型：提交 |

3. **配置初始设置**

   - **隐藏附加扣款字段**：
      - 选择“附加扣款”组件
      - 在“属性”面板中，将&#x200B;**Visible**&#x200B;设置为&#x200B;**No**
      - 此字段将根据规则有条件地显示

   - **将计算字段设为只读**：
      - 选择“应纳税所得”和“应付税”字段
      - 在属性中将&#x200B;**只读**&#x200B;设置为&#x200B;**是**

     ![计税表单截图，包含税前工资、婚姻状况和受抚养子女的输入字段，说明了规则应用之前的表单结构](/help/edge/docs/forms/assets/rule-editor2.png)
     *图：配置基本组件的初始窗体结构*

**检查点**：您现在应该有一个包含所有必填字段的表单，其中“Additional Deduction”是隐藏的，计算字段是只读的。

+++

+++ &#x200B;2. 为表单字段添加条件规则

创作表单后，编写第一条规则，即只有当工资总额超过 50000 美元时才显示 `Additional Deduction` 字段。要添加条件规则：

1. 在通用编辑器中打开要编辑的表单，在内容树中选择&#x200B;**[!UICONTROL 工资总额]**&#x200B;字段，然后选择![编辑-规则](/help/forms/assets/edit-rules-icon.svg)。或者，也可以直接从&#x200B;**[!UICONTROL 表单对象]**&#x200B;窗格中选择&#x200B;**[!UICONTROL 工资总额]**&#x200B;字段。
   ![规则编辑器示例 1](/help/edge/docs/forms/assets/rule-editor3.png)
出现可视化规则编辑器界面。
1. 单击&#x200B;**[!UICONTROL 创建]**&#x200B;以创建规则。
   ![规则编辑器示例 2](/help/edge/docs/forms/assets/rule-editor4.png)
默认情况下，已选择 `Set Value Of` 规则类型。虽然不能更改或修改所选对象，但可以使用规则下拉列表选择其他规则类型。\
   ![规则编辑器示例 3](/help/edge/docs/forms/assets/rule-editor5.png)
1. 打开规则类型下拉列表，并选择&#x200B;**[!UICONTROL 时间]**&#x200B;规则类型。
   ![规则编辑器示例 4](/help/edge/docs/forms/assets/rule-editor6.png)
1. 选择&#x200B;**[!UICONTROL 选择状态]**&#x200B;下拉列表，并选择&#x200B;**[!UICONTROL 大于]**。出现&#x200B;**[!UICONTROL 输入数字]**&#x200B;字段。
   ![规则编辑器示例 5](/help/edge/docs/forms/assets/rule-editor7.png)
1. 在规则&#x200B;**[!UICONTROL 输入数字]**&#x200B;字段中输入 `50000`。
   ![规则编辑器示例 6](/help/edge/docs/forms/assets/rule-editor8.png)
您已将条件定义为 `When Gross Salary is greater than 50000`。接下来，定义如果条件为 `True` 时要执行的操作。
1. 在 `Then` 声明中，从&#x200B;**[!UICONTROL 选择操作]**&#x200B;下拉列表中选择&#x200B;**[!UICONTROL 显示]**。
   ![规则编辑器示例 7](/help/edge/docs/forms/assets/rule-editor9.png)
1. 从&#x200B;**[!UICONTROL 放置对象或选择此处]**&#x200B;字段上的“表单对象”选项卡拖放&#x200B;**[!UICONTROL 额外扣除]**&#x200B;字段。或者，从列出了表单中所有表单对象的弹出窗口菜单选择&#x200B;**[!UICONTROL 放置对象或选择此处]**&#x200B;字段，并选择&#x200B;**[!UICONTROL 额外扣除]**&#x200B;字段。
   ![规则编辑器示例 8](/help/edge/docs/forms/assets/rule-editor10.png)
1. 如果输入的工资低于 `50000`，单击&#x200B;**[!UICONTROL 添加其他部分]**&#x200B;为&#x200B;**[!UICONTROL 工资总额]**&#x200B;字段添加另一个条件。
   ![规则编辑器示例 9](/help/edge/docs/forms/assets/rule-editor11.png)
1. 在 `Else` 声明中，从&#x200B;**[!UICONTROL 选择操作]**&#x200B;下拉列表中选择&#x200B;**[!UICONTROL 隐藏]**。
   ![规则编辑器示例 10](/help/edge/docs/forms/assets/rule-editor12.png)
1. 从&#x200B;**[!UICONTROL 放置对象或选择此处]**&#x200B;字段上的“表单对象”选项卡拖放&#x200B;**[!UICONTROL 额外扣除]**&#x200B;字段。或者，从列出了表单中所有表单对象的弹出窗口菜单选择&#x200B;**[!UICONTROL 放置对象或选择此处]**&#x200B;字段，并选择&#x200B;**[!UICONTROL 额外扣除]**&#x200B;字段。
   ![规则编辑器示例 11](/help/edge/docs/forms/assets/rule-editor13.png)
1. 选择&#x200B;**[!UICONTROL 完成]**&#x200B;保存规则。
规则编辑器中的规则显示如下。
   ![规则编辑器示例 12](/help/edge/docs/forms/assets/rule-editor14.png)

>[!NOTE]
>
> 或者，您也可以在“额外扣除”字段上编写“显示”规则，而不是在“工资总额”字段上编写“时间”规则，以实施相同的行为。

+++

+++ &#x200B;3. 添加表单字段的计算规则

接下来，编写规则计算 `Taxable Income`，即 `Gross Salary` 和 `Additional Deduction` 之间的差值（如果适用）。要在&#x200B;**[!UICONTROL 应税收入]**&#x200B;字段添加计算规则，请执行以下步骤：

1. 在创作模式下，选择&#x200B;**[!UICONTROL 应税收入]**&#x200B;字段，并选择![编辑-规则](/help/forms/assets/edit-rules-icon.svg)图标。或者，也可以直接从&#x200B;**[!UICONTROL 表单对象]**&#x200B;窗格中选择&#x200B;**[!UICONTROL 应税收入]**&#x200B;字段。
1. 接下来，选择&#x200B;**[!UICONTROL 创建]**&#x200B;以创建规则。
   ![规则编辑器示例 13](/help/edge/docs/forms/assets/rule-editor16.png)
1. 选择&#x200B;**[!UICONTROL 选择选项]**，并选择&#x200B;**[!UICONTROL 数学表达式]**。打开用于编写数学表达式的字段。
   ![规则编辑器示例 14](/help/edge/docs/forms/assets/rule-editor17.png)

1. 在数学表达式字段中：

   - 从“表单对象”选项卡中选择或拖放第一个&#x200B;**[!UICONTROL 放置对象或在此处选择]**&#x200B;字段中的&#x200B;**[!UICONTROL 工资总额]**&#x200B;字段。

   - 从&#x200B;**[!UICONTROL 选择运算符]**&#x200B;字段中选择&#x200B;**[!UICONTROL 减号]**。

   - 从“表单对象”选项卡中选择或拖放另一个&#x200B;**[!UICONTROL 放置对象或在此处选择]**&#x200B;字段中的&#x200B;**[!UICONTROL 额外扣除]**&#x200B;字段。
     ![规则编辑器示例 15](/help/edge/docs/forms/assets/rule-editor18.png)

1. 选择&#x200B;**[!UICONTROL 完成]**&#x200B;保存规则。

   现在，为 `Tax Payable ` 字段添加规则，该规则由应税收入乘以税率确定。为简单起见，假设固定税率为 `10%`。

1. 在创作模式下，选择&#x200B;**[!UICONTROL 应缴税款]**&#x200B;字段，并选择![编辑-规则](/help/forms/assets/edit-rules-icon.svg)图标。接下来，选择&#x200B;**[!UICONTROL 创建]**&#x200B;以创建规则。
   ![规则编辑器示例 16](/help/edge/docs/forms/assets/rule-editor19.png)
1. 选择&#x200B;**[!UICONTROL 选择选项]**，并选择&#x200B;**[!UICONTROL 数学表达式]**。打开用于编写数学表达式的字段。
   ![规则编辑器示例 17](/help/edge/docs/forms/assets/rule-editor20.png)
1. 在数学表达式字段中：

   - 从“表单对象”选项卡中选择或拖放第一个&#x200B;**[!UICONTROL 放置对象或在此处选择]**&#x200B;字段中的&#x200B;**[!UICONTROL 应税收入]**&#x200B;字段。

   - 从&#x200B;**[!UICONTROL 选择运算符]**&#x200B;字段中选择&#x200B;**[!UICONTROL 乘以]**。

   - 从&#x200B;**[!UICONTROL 选择选项]**&#x200B;字段中选择&#x200B;**数字**，然后在&#x200B;**[!UICONTROL 输入数字]**&#x200B;字段中输入值 `10`。
     ![规则编辑器示例 18](/help/edge/docs/forms/assets/rule-editor21.png)
1. 接下来，选择表达式字段周围的突出显示区域，并选择&#x200B;**[!UICONTROL 扩展表达式]**。
   ![规则编辑器示例 19](/help/edge/docs/forms/assets/rule-editor22.png)
1. 在扩展表达式字段中，从&#x200B;**[!UICONTROL 选择运算符]**&#x200B;字段中选择&#x200B;**[!UICONTROL 除以]**，并从&#x200B;**[!UICONTROL 选择选项]**&#x200B;字段中选择&#x200B;**[!UICONTROL 数字]**。然后，在数字字段中指定 `100`。
   ![规则编辑器示例 20](/help/edge/docs/forms/assets/rule-editor23.png)
1. 选择&#x200B;**[!UICONTROL 完成]**&#x200B;保存规则。

+++

+++ &#x200B;4. 预览表单

现在，当您预览表单并将&#x200B;**工资总额**&#x200B;输入为 `60,000` 时，会出现&#x200B;**额外扣除**&#x200B;字段，并会相应地计算出&#x200B;**应税收入**&#x200B;和&#x200B;**应缴税款**。

![预览表单](/help/edge/docs/forms/assets/rule-editor-form.png)

+++

除了内置函数（如Sum和Average ）之外，您还可以创建自定义函数以实施根据特定要求定制的复杂业务逻辑。

## 高级：自定义函数

**何时使用自定义函数：**

- 对于超出内置函数功能的复杂计算
- 实施特定于业务的验证规则
- 用于数据转换和格式化
- 与外部系统或API集成

**福利：**

- **可重用性**：写入函数一次，然后跨多个表单和规则使用它
- **可维护性**：易于更新的集中式逻辑
- **性能**：优化的JavaScript执行
- **灵活性**：能够处理标准规则未解决的复杂方案

### **正在创建自定义函数**

您的AEM项目中的&#x200B;**文件位置**： `/blocks/form/functions.js`

**开发工作流：**

1. **函数声明**
   - 定义清楚的描述性函数名称和参数
   - 使用指示函数用途的名称
   - 文档参数和返回类型

2. **逻辑实现**
   - 编写简洁高效的JavaScript代码
   - 处理边缘案例和错误方案
   - 遵循编码最佳实践

3. **函数导出**
   - 导出函数以便在规则编辑器中可用
   - 使用指定的导出进行更好的组织
   - 部署前测试功能

4. **文档**
   - 为函数文档添加JSDoc注释
   - 包括用法示例
   - 指定参数类型和返回值

以下示例演示了两个自定义函数：`getFullName`和`days`。

```JavaScript
/**
 - Get Full Name
 - @name getFullName Concats first name and last name
 - @param {string} firstname in Stringformat
 - @param {string} lastname in Stringformat
 - @return {string}
 */
function getFullName(firstname, lastname) {
  return `${firstname} ${lastname}`.trim();
}

/**
 - Calculate the number of days between two dates.
 - @param {*} endDate
 - @param {*} startDate
 - @name days Calculates the numebr of days between two dates
 - @returns {number} returns the number of days between two dates
 */
function days(endDate, startDate) {
  const start = typeof startDate === 'string' ? new Date(startDate) : startDate;
  const end = typeof endDate === 'string' ? new Date(endDate) : endDate;

  // return zero if dates are valid
  if (Number.isNaN(start.getTime()) || Number.isNaN(end.getTime())) {
    return 0;
  }

  const diffInMs = Math.abs(end.getTime() - start.getTime());
  return Math.floor(diffInMs / (1000 * 60 * 60 * 24));
}

// eslint-disable-next-line import/prefer-default-export
export { getFullName, days };
```

![添加自定义函数](/help/edge/docs/forms/assets/create-custom-function.png)

### 使用规则编辑器中的自定义函数

要在规则编辑器中使用自定义函数，请执行以下操作：

1. **添加函数**：将自定义函数添加到`../[blocks]/form/functions.js`文件。 请确保将其包含在文件中的`export`语句中。
2. **部署文件**：将更新的`functions.js`文件部署到GitHub项目，并确认生成成功完成。
3. **函数用法**：在表单的规则编辑器中，通过在`Function Output`选择操作&#x200B;**[!UICONTROL 字段中选择]**&#x200B;选项来访问该函数。

   ![规则编辑器中的自定义函数](/help/edge/docs/forms/assets/custom-function-rule-editor.png)

4. **预览表单**：预览您的表单，验证新实现的函数是否按预期工作。

## 规则开发的最佳实践

### **性能优化**

**最小化规则复杂性**

- 保持单个规则的简单性和集中性。
- 将复杂的逻辑分解为多个较小的规则。
- 尽可能避免深度嵌套的条件。

**优化规则执行**

- 将最常触发的规则放在最前面。
- 使用特定条件减少不必要的评估。
- 考虑规则对表单加载时间的影响。

**资源管理**

- 限制每个表单组件的规则数。
- 将自定义函数用于重复逻辑，而不是复制规则。
- 用真实的数据量测试性能。

### **用户体验准则**

**提供明确的反馈**

- 使用验证消息引导用户正确输入。
- 显示正在加载涉及外部服务的规则的指示器。
- 实施渐进式披露以降低认知负担。

**保持表单响应**

- 避免使用会导致视觉突变的规则。
- 为显示/隐藏操作实施平滑过渡。
- 测试跨不同设备和屏幕大小的规则。

**错误处理**

- 在规则失败时提供回退行为。
- 显示用户友好的错误消息。
- 记录调试错误，同时保持良好的用户体验。

### **开发最佳实践**

**测试策略**

- 测试包含边缘用例和边界值的规则。
- 验证不同浏览器中的规则行为。
- 在不启用JavaScript的情况下测试表单功能。

**文档**

- 记录复杂规则背后的业务逻辑。
- 维护大型表单的规则库存。
- 对组件和规则使用一致的命名约定。

**版本控制**

- 在版本控制中跟踪对自定义函数的更改。
- 在生产之前测试开发环境中的规则。
- 维护工作规则配置的备份副本。

## 常见问题疑难解答

### **规则执行问题**

**规则未触发**

- **检查组件名称**：确保引用的组件存在并具有正确的名称。
- **验证规则顺序**：规则从上到下执行；如果需要，请重新排序。
- **验证条件**：使用已知值测试条件以验证逻辑。
- **浏览器控制台**：检查可能阻止执行的JavaScript错误。

**不正确的规则行为**

- **查看逻辑运算符**：确认AND/OR条件结构正确。
- **使用示例数据进行测试**：使用已知值隔离问题。
- **检查数据类型**：确保数值比较使用数字，而不是字符串。
- **验证表达式**：单独测试数学表达式。

### **性能问题**

**慢速表单响应**

- **降低规则复杂性**：简化复杂的条件逻辑。
- **优化自定义函数**：配置并优化JavaScript代码。
- **限制外部调用**：最小化规则中的服务调用。
- **使用有效的选择器**：确保表单对象引用是特定的。

**内存使用率**

- **清理事件侦听器**：删除未使用的规则绑定。
- **优化自定义函数**：避免JavaScript代码中的内存泄漏。
- **限制规则范围**：使用目标规则而不是全局条件。

### **自定义函数问题**

**函数不可用**

- **检查文件路径**：验证`functions.js`是否位于正确的位置： `/blocks/form/functions.js`。
- **验证导出**：确保函数已正确导出。
- **生成流程**：确认项目生成包含更新的函数文件。
- **缓存清除**：部署新函数后清除浏览器缓存。

**函数错误**

- **参数验证**：检查函数参数是否与预期类型匹配。
- **错误处理**：添加try-catch块以正常处理异常。
- **控制台日志记录**：使用console.log执行调试函数。
- **JSDoc验证**：确保函数文档与实现匹配。

### **通用编辑器集成**

**规则编辑器未出现**

- **扩展已启用**：验证规则编辑器扩展是否已激活。
- **组件选择**：确保您选择了受支持的表单组件。
- **浏览器兼容性**：在支持的浏览器(Chrome、Firefox、Safari)中进行测试。
- **访问权限**：确认用户具有必要的AEM权限。

**接口问题**

- **面板可见性**：使用切换按钮显示或隐藏表单对象面板。
- **规则保存**：确保在关闭编辑器之前保存规则。
- **浏览器缩放**：将浏览器缩放重置为100%以获得最佳的界面显示。

## 重要限制

>[!IMPORTANT]
>
> **自定义函数限制**：
>
> - 自定义函数脚本不支持静态和动态导入。
> - 所有代码必须直接包含在`/blocks/form/functions.js`文件中。
> - 函数必须为同步（无异步/等待或Promise）。
> - 出于安全原因，对浏览器API的访问受到限制。

>[!WARNING]
>
> **生产注意事项**：
>
> - 在暂存环境中彻底测试所有规则。
> - 在部署复杂规则后监视窗体性能。
> - 具有与规则相关问题的回滚计划。
> - 考虑对网络连接速度较慢的用户的影响。

## 摘要

通用编辑器中的规则编辑器允许您创建智能的动态表单，这些表单可提供卓越的用户体验。 通过实施条件逻辑、自动计算和自定义业务规则，您可以：

**转换静态Forms**：

- 为更清晰、更集中的界面添加条件字段可见性。
- 实施实时计算和数据验证。
- 无需编码即可创建完善的业务逻辑。

**改善用户体验**：

- 引导用户完成逻辑表单流程。
- 通过智能验证减少错误。
- 立即提供反馈和帮助。

**提高效率**：

- 自动执行重复计算和数据输入。
- 使用智能路由简化复杂的工作流。
- 借助自助服务功能减轻支持负担。

### **后续步骤**

现在您已了解规则编辑器基础知识：

1. **开始简单**：在进入复杂计算之前，先从基本的显示/隐藏规则开始。
1. **实践示例**：使用税务计算器教程作为基础。
1. **探索高级功能**：尝试使用自定义函数以满足特殊要求。
1. **彻底测试**：始终验证不同方案和设备之间的规则。
1. **监视器性能**：确保规则增强而不是阻碍用户体验。
